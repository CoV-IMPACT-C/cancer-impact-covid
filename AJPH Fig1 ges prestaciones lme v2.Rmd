---
title: "Figura ges prestaciones lme"
output: html_document
---


```{r LIBRERIAS, message=FALSE, warning=FALSE, include=FALSE}
rm(list = ls())
library(data.table)
library(tidyverse)
library(ggpubr)
library(haven)
```

# Datos

## GES agregados, por sexo y previsión
```{r}
dat.todos <- as.data.table(read_dta("diag confirms/output/DB/all cancers observed predicted counterfactual.dta"))[, cancer := "All Cancers"]

dat.mama <- as.data.table(read_dta("diag confirms/output/DB/Cáncer de mamas (tabla con observados, predichos y contrafactual).dta"))[, cancer := "Breast Cancer"]

dat.test <- as.data.table(read_dta("diag confirms/output/DB/Cáncer de testículo (tabla con observados, predichos y contrafactual).dta"))[, cancer := "Testicular Cancer"]

dat.cerv <- as.data.table(read_dta("diag confirms/output/DB/Cervix cancer (tabla con observados, predichos y contrafactual).dta"))[, cancer := "Cervical Cancer"]

dat.colo <- as.data.table(read_dta("diag confirms/output/DB/Cáncer colorectal (tabla con observados, predichos y contrafactual).dta"))[, cancer := "Colorectal Cancer"]

dat.gast <- as.data.table(read_dta("diag confirms/output/DB/Cáncer gástrico (tabla con observados, predichos y contrafactual).dta"))[, cancer := "Gastric Cancer"]

dat.leuk <- as.data.table(read_dta("diag confirms/output/DB/Leucemia (tabla con observados, predichos y contrafactual).dta"))[, cancer := "Leukemia"]

dat.lymp <- as.data.table(read_dta("diag confirms/output/DB//Linfoma (tabla con observados, predichos y contrafactual).dta"))[, cancer := "Lymphoma"]

dat <- rbind(dat.cerv, dat.colo, dat.gast, dat.leuk, dat.lymp, dat.mama, dat.test, dat.todos)

#dat.todos.sex <- as.data.table(read_dta("diag confirms/output/DB/all cancers observed predicted counterfactual by sex.dta"))[, cancer := "All Cancers"]

#dat.todos.prev <- as.data.table(read_dta("diag confirms/output/DB/all cancers observed predicted counterfactual by insurance 1 missing.dta"))[, cancer := "All Cancers"]

rm(dat.cerv, dat.colo, dat.gast, dat.leuk, dat.lymp, dat.mama, dat.test, dat.todos)
```

```{r}
. <- dat[
  , sexo := factor(sexo, levels = 1:2, labels = c("Male", "Female")) ][
  , edad_cat := factor(rango_etario, levels = 1:7, labels = c("[20,30)", "[30,40)", "[40,50)", "[50,60)", 
                                                              "[60,70)", "[70,80)", "[80,90)"))  ][
  , edad_cat := relevel(edad_cat, "[40,50)")  ][
  , year := as.numeric(ano)  ][
  , week := as.factor(semana)  ][#ojo! estas semanas se construyeron de forma distinta: contiene 52 semanas por año en lugar de 53
  , time := as.numeric(t)  ][
  , pandemia := as.numeric(level)  ][
  , time_after := as.numeric(slope)  ][
  , count := as.numeric(`_freq`)  ][
  , yhat :=  as.numeric(nhat)][
  , ub :=  as.numeric(llim_nh)][
  , lb :=  as.numeric(ulim_nh)][
  , cf :=  as.numeric(nhat0)][
  , cf_ub :=  as.numeric(llim_nh0)][
  , cf_lb :=  as.numeric(ulim_nh0)][
  , grupo.trz :=  as.factor(cancer)][
  , .(week, year, sexo, edad_cat, count, pandemia, time, time_after, yhat, ub, lb, cf, cf_ub, cf_lb, grupo.trz) ]

dat.plots.agg.ges <- .[grupo.trz == "All Cancers"][, -("grupo.trz")]

rm(dat)

```


## Prestaciones agregados

```{r DATA LABELS}
prest <- c("Oncology out-patient visits", "Cancer-related antigen test", "Biopsies", "Neoplastic Cells test" , "PET-CT", 
            "Fecal occult bleeding test", "Sigmoidoscopy and\nColonoscopy", 
            "Cervical Biopsy", "Colposcopy", "Papanicolaou", 
            "Esophagoscopy,\nGastroduodenoscopy,\nYeyuno Ileoscopy", "Ureasa tests", 
            "Breast Ultrasound", "Mammography", "Breast MRI",
            "Prostate-Specific\nAntigen", "Prostate Ultrasound")

prest.sexo <- c("Oncology out-patient visits", "Cancer-related antigen test", "Biopsies", "Neoplastic Cells test" , "PET-CT", 
            "Fecal occult bleeding test", "Sigmoidoscopy and\nColonoscopy", 
            "Esophagoscopy, Gastroduodenoscopy, Yeyuno Ileoscopy", "Ureasa tests")
```

```{r LOAD DATA PLOTS}
load("health services/output/DB/DB predichos nb sti.RData")
dat.plots.agg.prest <- dat.plots
```

## LME agregados

```{r DATA}

load(file = "sick leaves/output/DB/DB predichos nb sti.RData")

dat.plots.agg.lme<-dat.plots

rm(dat.plots)
```


# Figuras

## GES agregada

## Figura 1 suplementaria por tipo

```{r FIG1, fig.width=6, fig.height=6, message=FALSE, warning=FALSE}
g1.agg.ges <- dat.plots.agg.ges %>% 
#  filter(mod.int == "Additive") %>% 
  mutate(exposicion = ifelse(year == 2020, "2020", "2017-2019"),
         week=as.numeric(week)-1) %>%
  filter(!week==0) %>% 
  group_by(week, year, exposicion) %>% summarise(count = sum(count),
                                                 yhat = sum(yhat),
                                                 cf = sum(cf),
                                                 ub = sum(ub),
                                                 lb = sum(lb),
                                                 cf_ub = sum(cf_ub),
                                                 cf_lb = sum(cf_lb) ) %>% 
  group_by(week, exposicion)%>% summarise(count = mean(count),
                                          yhat = mean(yhat),
                                          cf = mean(cf),
                                          ub = mean(ub),
                                          lb = mean(lb),
                                          cf_ub = mean(cf_ub),
                                          cf_lb = mean(cf_lb) ) %>% 
  ggplot(aes(x = week, y = count, fill = exposicion))+
  geom_point(alpha = .3, aes(color = exposicion), size = 1) +
  geom_line(aes(x = week, y = yhat, color = exposicion, group = exposicion, linetype = "Observed")) +
  geom_ribbon(aes(ymin = lb, ymax = ub, group = exposicion), alpha = .3) +
  geom_line(aes(x = week, y = cf, color = exposicion, group = exposicion, linetype = "Predicted counterfactual"), 
            size = .3, name = "bla") +
  geom_ribbon(aes(ymin = cf_lb, ymax = cf_ub, group = exposicion), alpha = .15) +
  scale_linetype_manual(values = c("Observed" = 1, "Predicted counterfactual" = 2)) +
  ylim(0, NA) +
  scale_x_continuous(breaks = seq(5, 53, 6), limits = c(NA,52), expand = c(0,0)) +
#  xlim(0, 53) +
  theme_minimal() + 
  theme(panel.grid.minor.x = element_blank())+
  labs(y = "Count", x = "Week", fill = "Period", color = "Period", linetype = "Scenario",
       subtitle = "", title = "a. Cancer diagnostic confirmations") +
  geom_vline(xintercept = 11, linetype = "dotted", color = "red") + 
  theme(legend.position = "bottom",
        axis.title = element_text(size = 7),
        axis.text = element_text(size = 6),
        plot.subtitle = element_text(size = 7),
        plot.title = element_text(size = 11, face = "bold"))

g1.agg.ges

```



## Prestaciones

```{r FIG1, fig.width=6, fig.height=9, message=FALSE, warning=FALSE}
g1.agg.prest <- dat.plots.agg.prest %>% 
  filter(mod.int == "Additive",
        !week==53) %>% 
  mutate(exposicion = ifelse(year == 2020, "2020", "2018-2019")) %>% 
  group_by(week, year, exposicion) %>% summarise(count = sum(count),
                                                 yhat = sum(yhat),
                                                 cf = sum(cf),
                                                 ub = sum(ub),
                                                 lb = sum(lb),
                                                 cf_ub = sum(cf_ub),
                                                 cf_lb = sum(cf_lb) ) %>% 
  group_by(week, exposicion)%>% summarise(count = mean(count),
                                          yhat = mean(yhat),
                                          cf = mean(cf),
                                          ub = mean(ub),
                                          lb = mean(lb),
                                          cf_ub = mean(cf_ub),
                                          cf_lb = mean(cf_lb) ) %>% 
  ggplot(aes(x = week, y = count, fill = exposicion))+
  geom_point(alpha = .3, aes(color = exposicion), size = 1) +
  geom_line(aes(x = week, y = yhat, color = exposicion, group = exposicion, linetype = "Observed")) +
  geom_ribbon(aes(ymin = lb, ymax = ub, group = exposicion), alpha = .3) +
  geom_line(aes(x = week, y = cf, color = exposicion, group = exposicion, linetype = "Predicted counterfactual"), 
            size = .3, name = "bla") +
  geom_ribbon(aes(ymin = cf_lb, ymax = cf_ub, group = exposicion), alpha = .15) +
  scale_linetype_manual(values = c("Observed" = 1, "Predicted counterfactual" = 2)) +
  ylim(0, NA) +
  xlim(NA, 52) +
  scale_x_discrete(breaks = seq(5, 53, 6), expand = c(0, 0)) +
  theme_minimal() + 
  labs(y = "Count", x = "Week", fill = "Period", color = "Period", linetype = "Scenario",
       subtitle = "", title = "b. Cancer-related outpatient services") +
  geom_vline(xintercept = 11, linetype = "dotted", color = "red") + 
  theme(legend.position = "bottom",
        axis.title = element_text(size = 7),
        axis.text.y = element_text(size = 5),
        axis.text.x = element_text(size = 6),
        plot.subtitle = element_text(size = 7),
        plot.title = element_text(size = 11, face = "bold"))

g1.agg.prest
```

## LME

```{r FIG1, fig.width=6, fig.height=11, message=FALSE, warning=FALSE}

g1.agg.lme <- dat.plots.agg.lme %>% 
  mutate(week = as.numeric(week)) %>% 
  filter(mod.int == "Additive",
        !week==53) %>% 
  mutate(exposicion = ifelse(year == 2020, "2020", "2018-2019")) %>% 
  group_by(week, year, exposicion) %>% summarise(count = sum(count),
                                                 yhat = sum(yhat),
                                                 cf = sum(cf),
                                                 ub = sum(ub),
                                                 lb = sum(lb),
                                                 cf_ub = sum(cf_ub),
                                                 cf_lb = sum(cf_lb) ) %>% 
  group_by(week, exposicion)%>% summarise(count = mean(count),
                                          yhat = mean(yhat),
                                          cf = mean(cf),
                                          ub = mean(ub),
                                          lb = mean(lb),
                                          cf_ub = mean(cf_ub),
                                          cf_lb = mean(cf_lb) ) %>% 
  ggplot(aes(x = week, y = count, fill = exposicion)) +
  geom_point(alpha = .3, aes(color = exposicion), size = 1.5) +
  geom_line(aes(x = week, y = yhat, color = exposicion, linetype = "Observed")) +
  geom_ribbon(aes(ymin = lb, ymax = ub, group = exposicion), alpha = .3) +
  geom_line(aes(x = week, y = cf, color = exposicion, linetype = "Predicted counterfactual"), 
            size = .3, name = "bla") +
  geom_ribbon(aes(ymin = cf_lb, ymax = cf_ub, group = exposicion), alpha = .15) +
  scale_linetype_manual(values = c("Observed" = 1, "Predicted counterfactual" = 2)) +
  ylim(0, NA) +
  theme_minimal() +
  scale_x_continuous(breaks = seq(5, 53, 6), expand = c(0, 0), limits = c(NA, 52)) +
  theme(panel.grid.minor.x = element_blank())+
  labs(y = "Count", x = "Week", fill = "Period", color = "Period", linetype = "Scenario",
       subtitle = "", title = "c. Cancer sick leaves") +
  geom_vline(xintercept = 11, linetype = "dotted", color = "red") + 
  theme(legend.position = "bottom",
        axis.title = element_text(size = 7),
        axis.text = element_text(size = 6),
        plot.subtitle = element_text(size = 8),
        plot.title = element_text(size = 11, face = "bold"))

g1.agg.lme


```

## Combine

```{r FIG1, fig.width=6, fig.height=11, message=FALSE, warning=FALSE}

g1 <- ggarrange(g1.agg.ges, 
                g1.agg.prest, g1.agg.lme, ncol = 1,
                common.legend = T, legend.grob = get_legend(g1.agg.prest), legend = "top")


g1

ggsave(plot = g1,
       filename = "all services/AJPH fig1 v2.pdf", 
       device = "pdf",
       dpi = "retina",
       width = 8, height = 12)
```